# MCP Container Sandbox Server - ìžë™ ë°°í¬ ì›Œí¬í”Œë¡œìš°
#
# ì´ ì›Œí¬í”Œë¡œìš°ëŠ” main ë¸Œëžœì¹˜ì— í‘¸ì‹œë  ë•Œ ìžë™ìœ¼ë¡œ Hostinger VPSì— ë°°í¬í•©ë‹ˆë‹¤.
#
# í•„ìš”í•œ GitHub Secrets:
#   - VPS_HOST: VPS IP ì£¼ì†Œ ë˜ëŠ” ë„ë©”ì¸ (ì˜ˆ: playmcp-sandbox-computer.bloupla.net)
#   - VPS_USER: SSH ì‚¬ìš©ìžëª… (ë³´í†µ root)
#   - VPS_SSH_KEY: SSH ê°œì¸í‚¤ (id_rsa ë˜ëŠ” id_ed25519 ë‚´ìš©)
#   - VPS_PORT: SSH í¬íŠ¸ (ì„ íƒì‚¬í•­, ê¸°ë³¸ê°’ 22)
#
# Secrets ì„¤ì • ë°©ë²•:
#   1. GitHub ì €ìž¥ì†Œ â†’ Settings â†’ Secrets and variables â†’ Actions
#   2. "New repository secret" í´ë¦­
#   3. ìœ„ Secretsë“¤ì„ í•˜ë‚˜ì”© ì¶”ê°€

name: Deploy to VPS

on:
  push:
    branches:
      - main
  workflow_dispatch:  # ìˆ˜ë™ ì‹¤í–‰ í—ˆìš©

env:
  APP_DIR: /opt/mcp-container-server
  SERVICE_NAME: mcp-container

jobs:
  deploy:
    name: Deploy to Hostinger VPS
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.VPS_SSH_KEY }}" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          ssh-keyscan -p ${{ secrets.VPS_PORT || 22 }} -H ${{ secrets.VPS_HOST }} >> ~/.ssh/known_hosts 2>/dev/null || true

      - name: Deploy to VPS
        env:
          SSH_HOST: ${{ secrets.VPS_HOST }}
          SSH_USER: ${{ secrets.VPS_USER }}
          SSH_PORT: ${{ secrets.VPS_PORT || 22 }}
        run: |
          ssh -i ~/.ssh/deploy_key -p $SSH_PORT $SSH_USER@$SSH_HOST << 'DEPLOY_SCRIPT'
            set -e
            
            echo "========================================="
            echo "ðŸš€ MCP Container Server ë°°í¬ ì‹œìž‘"
            echo "========================================="
            
            APP_DIR="/opt/mcp-container-server"
            SERVICE_NAME="mcp-container"
            BACKUP_DIR="${APP_DIR}-backup-$(date +%Y%m%d%H%M%S)"
            
            # ë°±ì—… ìƒì„±
            if [ -d "$APP_DIR" ]; then
              echo "ðŸ“¦ ê¸°ì¡´ ë²„ì „ ë°±ì—… ì¤‘..."
              cp -r "$APP_DIR" "$BACKUP_DIR"
            fi
            
            cd "$APP_DIR"
            
            # Git pull
            echo "ðŸ“¥ ìµœì‹  ì½”ë“œ ê°€ì ¸ì˜¤ê¸°..."
            git fetch origin main
            git reset --hard origin/main
            
            # ì˜ì¡´ì„± ì„¤ì¹˜ ë° ë¹Œë“œ
            echo "ðŸ“¦ ì˜ì¡´ì„± ì„¤ì¹˜ ì¤‘..."
            npm ci
            
            echo "ðŸ”¨ ë¹Œë“œ ì¤‘..."
            npm run build
            
            # í”„ë¡œë•ì…˜ ì˜ì¡´ì„±ë§Œ ìœ ì§€
            npm prune --omit=dev
            
            # ì„œë¹„ìŠ¤ ìž¬ì‹œìž‘
            echo "ðŸ”„ ì„œë¹„ìŠ¤ ìž¬ì‹œìž‘ ì¤‘..."
            systemctl restart $SERVICE_NAME
            
            # í—¬ìŠ¤ì²´í¬ ëŒ€ê¸°
            echo "â³ ì„œë²„ ì‹œìž‘ ëŒ€ê¸° ì¤‘..."
            sleep 3
            
            # í—¬ìŠ¤ì²´í¬ ê²€ì¦
            MAX_ATTEMPTS=10
            ATTEMPT=1
            while [ $ATTEMPT -le $MAX_ATTEMPTS ]; do
              if curl -s http://localhost:3000/health | grep -q '"status":"ok"'; then
                echo "âœ… í—¬ìŠ¤ì²´í¬ í†µê³¼!"
                break
              fi
              echo "ëŒ€ê¸° ì¤‘... ($ATTEMPT/$MAX_ATTEMPTS)"
              sleep 2
              ATTEMPT=$((ATTEMPT + 1))
            done
            
            if [ $ATTEMPT -gt $MAX_ATTEMPTS ]; then
              echo "âŒ í—¬ìŠ¤ì²´í¬ ì‹¤íŒ¨! ë¡¤ë°± ì¤‘..."
              if [ -d "$BACKUP_DIR" ]; then
                rm -rf "$APP_DIR"
                mv "$BACKUP_DIR" "$APP_DIR"
                systemctl restart $SERVICE_NAME
              fi
              exit 1
            fi
            
            # ë°±ì—… ì •ë¦¬ (ì„±ê³µ ì‹œ ìµœê·¼ 3ê°œë§Œ ìœ ì§€)
            echo "ðŸ§¹ ì˜¤ëž˜ëœ ë°±ì—… ì •ë¦¬ ì¤‘..."
            ls -dt /opt/mcp-container-server-backup-* 2>/dev/null | tail -n +4 | xargs rm -rf 2>/dev/null || true
            
            echo "========================================="
            echo "âœ… ë°°í¬ ì™„ë£Œ!"
            echo "========================================="
          DEPLOY_SCRIPT

      - name: Verify deployment
        run: |
          echo "ðŸ” ì™¸ë¶€ì—ì„œ í—¬ìŠ¤ì²´í¬ ê²€ì¦ ì¤‘..."
          sleep 5
          
          # VPS_HOSTë¥¼ ì‚¬ìš©í•˜ì—¬ í—¬ìŠ¤ì²´í¬ URL êµ¬ì„±
          HEALTH_URL="https://${{ secrets.VPS_HOST }}/health"
          echo "í—¬ìŠ¤ì²´í¬ URL: $HEALTH_URL"
          
          MAX_ATTEMPTS=5
          ATTEMPT=1
          while [ $ATTEMPT -le $MAX_ATTEMPTS ]; do
            HTTP_STATUS=$(curl -s -o /dev/null -w "%{http_code}" "$HEALTH_URL" 2>/dev/null || echo "000")
            if [ "$HTTP_STATUS" = "200" ]; then
              echo "âœ… ì™¸ë¶€ í—¬ìŠ¤ì²´í¬ í†µê³¼! (HTTP $HTTP_STATUS)"
              exit 0
            fi
            echo "ëŒ€ê¸° ì¤‘... (HTTP $HTTP_STATUS, $ATTEMPT/$MAX_ATTEMPTS)"
            sleep 3
            ATTEMPT=$((ATTEMPT + 1))
          done
          
          echo "âš ï¸ ì™¸ë¶€ í—¬ìŠ¤ì²´í¬ íƒ€ìž„ì•„ì›ƒ (ì„œë²„ ë‚´ë¶€ì—ì„œëŠ” ì •ìƒì¼ ìˆ˜ ìžˆìŒ)"
          # ê²½ê³ ë§Œ í‘œì‹œí•˜ê³  ì‹¤íŒ¨ë¡œ ì²˜ë¦¬í•˜ì§€ ì•ŠìŒ (DNS ì „íŒŒ ë“±ì˜ ì´ìœ ë¡œ)

      - name: Cleanup SSH
        if: always()
        run: rm -f ~/.ssh/deploy_key

  notify-failure:
    name: Notify on Failure
    runs-on: ubuntu-latest
    needs: deploy
    if: failure()
    
    steps:
      - name: Create failure summary
        run: |
          echo "## âŒ ë°°í¬ ì‹¤íŒ¨" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ë°°í¬ê°€ ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ë¡œê·¸ë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**ì»¤ë°‹:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "**ë¸Œëžœì¹˜:** ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "**ì‹œê°„:** $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
